<!DOCTYPE html><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>HTTP 缓存 | ICE.GS</title><meta name="description" content="A geeker blog."><meta name="keywords" content="hexo,theme,icer,ggice"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="现在的网络环境相比以前已经变得很好，其实不是太大的网页应用，不是运行在4G以下模式的手机上，一些速度优化的作用越来越少，一些沿用很久的优化理论可能已经不实用。我希望提供更多具有时代意义的优化建议，本文主要借鉴这篇 文章的优化建议。良好的HTTP缓存1.使用Etag 验证缓存的相应ETag的原理是，在请求文件时，服务器会生成并返回一个随机令牌（一般为文件哈希值）。客户端在下次请求时将令牌发送给服务器"><meta name="keywords" content="web development,web development推荐方法"><meta property="og:type" content="article"><meta property="og:title" content="HTTP 缓存"><meta property="og:url" content="https:&#x2F;&#x2F;ice.gs&#x2F;2016&#x2F;02&#x2F;24&#x2F;http-huan-cun&#x2F;index.html"><meta property="og:site_name" content="ICE.GS"><meta property="og:description" content="现在的网络环境相比以前已经变得很好，其实不是太大的网页应用，不是运行在4G以下模式的手机上，一些速度优化的作用越来越少，一些沿用很久的优化理论可能已经不实用。我希望提供更多具有时代意义的优化建议，本文主要借鉴这篇 文章的优化建议。良好的HTTP缓存1.使用Etag 验证缓存的相应ETag的原理是，在请求文件时，服务器会生成并返回一个随机令牌（一般为文件哈希值）。客户端在下次请求时将令牌发送给服务器"><meta property="og:locale" content="default"><meta property="og:image" content="https:&#x2F;&#x2F;ice.gs&#x2F;content&#x2F;images&#x2F;2016&#x2F;02&#x2F;http-cache-decision-tree-1.png"><meta property="og:image" content="https:&#x2F;&#x2F;ice.gs&#x2F;content&#x2F;images&#x2F;2016&#x2F;02&#x2F;http-cache-hierarchy.png"><meta property="og:updated_time" content="2016-02-23T22:02:25.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https:&#x2F;&#x2F;ice.gs&#x2F;content&#x2F;images&#x2F;2016&#x2F;02&#x2F;http-cache-decision-tree-1.png"><link rel="stylesheet" href="//cdn.staticfile.org/nprogress/0.2.0/nprogress.css"><link rel="stylesheet" href="//cdn.staticfile.org/highlight.js/9.15.10/styles/github-gist.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_405585_yuudmyqpo3q.css"><script src="//cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?403460ed7637fb6c4a9e09a74e662ca0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><meta name="generator" content="Hexo 4.0.0"></head></html><body><script>NProgress.start()</script><div id="site-wrapper"><header class="header"><div class="header-wrapper"><a href="/"><img src="/image/logo.jpg" class="logo"></a><div class="social-wrapper"><a href="https://twitter.com/iggice" class="social twitter" target="_blank" rel="external"><span class="iconfont icon-twitter"></span> </a><a href="https://github.com/ggice" class="social github" target="_blank" rel="external"><span class="iconfont icon-github"></span> </a><a href="http://ggice.lofter.com/" class="social lofter" target="_blank" rel="external"><span class="iconfont icon-lofter"></span> </a><a href="https://dribbble.com/ggice" class="social dribbble" target="_blank" rel="external"><span class="iconfont icon-dribbble"></span> </a><a href="mailto:i@ice.gs" class="social email" target="_blank" rel="external"><span class="iconfont icon-email"></span> </a><a href="/atom.xml" class="social rss" target="_blank" rel="external"><span class="iconfont icon-rss"></span> </a><a href="#" class="social search-do" target="_blank" rel="external"><span class="iconfont icon-search"></span></a></div><div class="search-wrap"><div class="search-content animated fade-in"><p class="search-input"><span class="iconfont icon-search"></span> <input tabindex="1"></p><ul class="search-result"><div class="tags"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac-os-X/" rel="tag">Mac os X</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/" rel="tag">os</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry-pi/" rel="tag">raspberry pi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/soft/" rel="tag">soft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development/" rel="tag">web development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development%E6%8E%A8%E8%8D%90%E6%96%B9%E6%B3%95/" rel="tag">web development推荐方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/work/" rel="tag">work</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%99%A8/" rel="tag">模块加载器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%BE%91%E5%99%A8/" rel="tag">编辑器</a></li></ul></div></ul></div></div><nav class="header-nav"><a href="/" class="archives">home </a><a href="/tags/web-development/" class="archives">web development </a><a href="/tags/soft/" class="archives">soft </a><a href="/tags/os/" class="archives">os </a><a href="/archives" class="archives">archives </a><a href="/README/" class="archives">README</a></nav></div></header><script>NProgress.set(.4)</script><main id="main" role="main"><article id="post-http-huan-cun" class="post article white-box article-type-post animated fade-in-top" itemscope itemprop="blogPost"><section class="post-header article-header"><h2 class="title"><a href="/2016/02/24/http-huan-cun/">HTTP 缓存</a></h2><div class="subtitle"><time>Feb 24, 2016 </time><span class="tags"><span class="iconfont icon-tag"></span> <a class="tag-link" href="/tags/web-development/" rel="tag">web development</a> / <a class="tag-link" href="/tags/web-development%E6%8E%A8%E8%8D%90%E6%96%B9%E6%B3%95/" rel="tag">web development推荐方法</a></span></div></section><section class="content"><div class="article-entry" itemprop="articleBody"><p>现在的网络环境相比以前已经变得很好，其实不是太大的网页应用，不是运行在4G以下模式的手机上，一些速度优化的作用越来越少，一些沿用很久的优化理论可能已经不实用。</p><p>我希望提供更多具有时代意义的优化建议，本文主要借鉴<a href="https://developers.google.com/web/fundamentals/performance/optimizing-content-efficiency/http-caching?hl=zh-cn" target="_blank" rel="noopener">这篇</a> 文章的优化建议。</p><h2 id="良好的HTTP缓存"><a href="#良好的HTTP缓存" class="headerlink" title="良好的HTTP缓存"></a>良好的HTTP缓存</h2><h3 id="1-使用Etag-验证缓存的相应"><a href="#1-使用Etag-验证缓存的相应" class="headerlink" title="1.使用Etag 验证缓存的相应"></a>1.使用Etag 验证缓存的相应</h3><p>ETag的原理是，在请求文件时，服务器会生成并返回一个随机令牌（一般为文件哈希值）。客户端在下次请求时将令牌发送给服务器，如果令牌一致，则跳过下载。</p><p>客户端会先校验ETag若相应未被修改，则在延用Cache-Control的设置时间。</p><p>在HTML5 Boilerplate中给出了流行服务器的<a href="https://github.com/h5bp/server-configs" target="_blank" rel="noopener">配置样例</a>。</p><h3 id="2-确定网站的最佳缓存层级"><a href="#2-确定网站的最佳缓存层级" class="headerlink" title="2.确定网站的最佳缓存层级"></a>2.确定网站的最佳缓存层级</h3><h4 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h4><blockquote><p>每个资源都可以通过 Cache-Control HTTP 头来定义自己的缓存策略<br>Cache-Control 指令控制谁在什么条件下可以缓存响应以及可以缓存多久</p></blockquote><p><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.9" target="_blank" rel="noopener">Cache-Control W3c描述文档</a></p><blockquote><p>Cache-Control 头在 HTTP/1.1 规范中定义，取代了之前用来定义响应缓存策略的头（例如 Expires）。当前的所有浏览器都支持 Cache-Control，因此，使用它就够了。</p></blockquote><p>默认请求资源会被缓存的，我们可以通过设置来修改是否缓存和明确缓存方式。</p><p>no-cache 表示必须咸鱼服务器确认返回的相应是否被更改,然后才能使用该响应来满足后续的请求。如果设置了验证令牌，no-cache会发起往返通讯来验证缓存的响应，如果未更改，则不下载。</p><p>no-store 直接禁止浏览器和所有中继缓存（CDN）返回的任何版本的响应，每次都会下载完整的响应。</p><p>public 表示即使有关联的http认证，甚至响应状态码无法正常缓存，响应也可以被缓存，大多数情况下，public不是必须的，因为明确的缓存信息（如max-age）已表示响应可以被缓存。</p><p>private 表示浏览器可以缓存private的响应，但是通常只为单个用户缓存，因此不允许任何中继缓存（如CDN）对其进行缓存。</p><p>max-age 该指令指定从当前请求开始，允许获取的响应被重用的最长时间（单位为秒）。</p><h4 id="缓存的层级关系"><a href="#缓存的层级关系" class="headerlink" title="缓存的层级关系"></a>缓存的层级关系</h4><p>下面这张图展示缓存的作用层级关系<br><img src="/content/images/2016/02/http-cache-decision-tree-1.png" alt></p><h4 id="设置合理的缓存级别"><a href="#设置合理的缓存级别" class="headerlink" title="设置合理的缓存级别"></a>设置合理的缓存级别</h4><p>对于网页应用我们既有缓存来优化加载，又希望我们的更新能使用户立即获得，对于一些大型的网页应用，在大的版本迭代中，若不能配合server及时更新前端代码，还可能造成应用无法使用的情况。</p><p><img src="/content/images/2016/02/http-cache-hierarchy.png" alt></p><ul><li><p>这是一个典型的层级加载优化事例，在入口的Html文件我们设置no-cache，这意味着每次请求时都会重新验证文档，若内容改变，会获取最新的版本。同时若css，js文件修改，通过指纹码修改css和js文件的文件名，入口的Html文件会随之更新，下载新的版本。</p></li><li><p>允许浏览器中继缓存 css 过期时间设置为1年。这是我们可以放心设置较长的时间，因为css的更新会同时更新网址，保证立即更新。</p></li><li><p>JavaScript 过期时间也设置为一年，但是被标记为private, 因为JavaScript可能包含一些个人数据，但是一般情况情况下private也是不需要的。</p></li><li>缓存图片是不包含版本或指纹码，过期时间设为一天。 这样做是会存在风险图片不能及时更新，例如css引用的图片更新，为了及时更新我们也需要给图片添加指纹码，之后我们可以放心的设置较长的缓存时间。</li></ul><h2 id="其他优化"><a href="#其他优化" class="headerlink" title="其他优化"></a>其他优化</h2><ul><li>同一资源使用相同的网址</li><li>利用CDN等中继缓存常用公共资源</li><li>更新最小化，经常更新的部分，考虑单独拉出文件，仅作这部分更新</li></ul><h2 id="问题-amp-BUG"><a href="#问题-amp-BUG" class="headerlink" title="问题&amp;BUG"></a>问题&amp;BUG</h2><p>上面所讲的理论在实践中，在不同浏览器、webview中并不一定如我们所愿的那样运作。可能会出现各种各样关于缓存的问题。在遇到具体问题时，会在下文具体分析解决。</p></div></section><section id="gitalk-container"></section></article><script>NProgress.set(.6)</script></main><footer class="footer"><div class="footer-wrap"><div class="footer-link"><h3>LINKS</h3><p><a href="http://1x0.xyz/" target="_blank">Tian1x0</a> <a href="http://www.royalmice.com/hankzhou/" target="_blank">Hankzhou</a> <a href="http://sjydh.me/" target="_blank">设计有点货</a> <a href="https://developers.google.com/web/fundamentals/" target="_blank">Web fundamentals</a></p></div><div class="footer-tags"><h3>TAGS</h3><div class="tags"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac-os-X/" rel="tag">Mac os X</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/" rel="tag">os</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/" rel="tag">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry-pi/" rel="tag">raspberry pi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/soft/" rel="tag">soft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development/" rel="tag">web development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development%E6%8E%A8%E8%8D%90%E6%96%B9%E6%B3%95/" rel="tag">web development推荐方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/work/" rel="tag">work</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97%E5%8A%A0%E8%BD%BD%E5%99%A8/" rel="tag">模块加载器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%BE%91%E5%99%A8/" rel="tag">编辑器</a></li></ul></div></div><div class="footer-info"><div>Theme <span class="codename"><a href="https://github.com/GGICE/hexo-icer" target="_blank">icer</a></span> designed & coded by <a href="https://ice.gs/" target="_blank">GGICE</a></div><div>Copyright &copy; 2020, <a href="/">ICE.GS</a> . All rights reserved .</div></div></div></footer><script>NProgress.set(.8)</script></div><script src="//cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script src="/js/main.js"></script><script src="/js/md5.js"></script><link rel="stylesheet" href="//cdn.staticfile.org/gitalk/1.5.0/gitalk.min.css"><script src="//cdn.staticfile.org/gitalk/1.5.0/gitalk.min.js"></script><script>document.querySelector("#gitalk-container")&&new Gitalk({clientID:"83a3413b0591f7c338af",clientSecret:"177f437bdc6573b374fa1ef51efb03e4c374d921",repo:"ICE.GS",owner:"GGICE",admin:["GGICE"],id:MD5(location.pathname),distractionFreeMode:!1}).render("gitalk-container")</script><script>NProgress.done()</script></body>