<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>基于JWT的登录验证系统实现 | ICE.GS</title><meta name="description" content="A geeker blog."><meta name="keywords" content="hexo,theme,icer,ggice"><meta name="HandheldFriendly" content="True"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="概述基于JWT的简单登录认证流程图：JWTJSON Web token（JWT）是一种开放标准（RFC 7519），它定义了一种紧凑且独立的方式，用于将各方之间的信息安全地传输为JSON对象。该信息可以通过数字签名进行验证和信任。使用密匙 （使用哈希算法）或使用RSA的公钥/私钥对可以对JWT进行签名。jwt是对于token认证方式的一种规范和描述。JWT 的构成jwt由三部分构成，并用.作为间隔"><meta name="keywords" content="web development"><meta property="og:type" content="article"><meta property="og:title" content="基于JWT的登录验证系统实现"><meta property="og:url" content="https://ice.gs/2017/06/01/ji-yu-jwtde-deng-lu-yan-zheng-xi-tong-shi-xian/index.html"><meta property="og:site_name" content="ICE.GS"><meta property="og:description" content="概述基于JWT的简单登录认证流程图：JWTJSON Web token（JWT）是一种开放标准（RFC 7519），它定义了一种紧凑且独立的方式，用于将各方之间的信息安全地传输为JSON对象。该信息可以通过数字签名进行验证和信任。使用密匙 （使用哈希算法）或使用RSA的公钥/私钥对可以对JWT进行签名。jwt是对于token认证方式的一种规范和描述。JWT 的构成jwt由三部分构成，并用.作为间隔"><meta property="og:locale" content="default"><meta property="og:image" content="https://ice.gs/images/2017/06/jwt-1.png"><meta property="og:image" content="https://ice.gs/images/2017/06/jwt-2.png"><meta property="og:updated_time" content="2017-06-01T22:14:30.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="基于JWT的登录验证系统实现"><meta name="twitter:description" content="概述基于JWT的简单登录认证流程图：JWTJSON Web token（JWT）是一种开放标准（RFC 7519），它定义了一种紧凑且独立的方式，用于将各方之间的信息安全地传输为JSON对象。该信息可以通过数字签名进行验证和信任。使用密匙 （使用哈希算法）或使用RSA的公钥/私钥对可以对JWT进行签名。jwt是对于token认证方式的一种规范和描述。JWT 的构成jwt由三部分构成，并用.作为间隔"><meta name="twitter:image" content="https://ice.gs/images/2017/06/jwt-1.png"><link rel="stylesheet" href="//cdn.x21.xyz/libs/nprogress/0.2.0/nprogress.css"><link rel="stylesheet" href="//cdn.x21.xyz/libs/highlight/9.12.0/styles/github-gist.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_405585_yuudmyqpo3q.css"><script src="//cdn.x21.xyz/libs/nprogress/0.2.0/nprogress.js"></script><link rel="stylesheet" href="/style.css"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?403460ed7637fb6c4a9e09a74e662ca0";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script></head></html><body><script>NProgress.start()</script><div id="site-wrapper"><header class="header"><div class="header-wrapper"><a href="/"><img src="/image/logo.jpg" class="logo"></a><div class="social-wrapper"><a href="https://twitter.com/iggice" class="social twitter" target="_blank" rel="external"><span class="iconfont icon-twitter"></span> </a><a href="https://github.com/ggice" class="social github" target="_blank" rel="external"><span class="iconfont icon-github"></span> </a><a href="http://ggice.lofter.com/" class="social lofter" target="_blank" rel="external"><span class="iconfont icon-lofter"></span> </a><a href="https://dribbble.com/ggice" class="social dribbble" target="_blank" rel="external"><span class="iconfont icon-dribbble"></span> </a><a href="mailto:i@ice.gs" class="social email" target="_blank" rel="external"><span class="iconfont icon-email"></span> </a><a href="/atom.xml" class="social rss" target="_blank" rel="external"><span class="iconfont icon-rss"></span> </a><a href="#" class="social search-do" target="_blank" rel="external"><span class="iconfont icon-search"></span></a></div><div class="search-wrap"><div class="search-content animated fade-in"><p class="search-input"><span class="iconfont icon-search"></span> <input tabindex="1"></p><ul class="search-result"><div class="tags"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac-os-X/">Mac os X</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/">os</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry-pi/">raspberry pi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/soft/">soft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development/">web development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development推荐方法/">web development推荐方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/work/">work</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模块加载器/">模块加载器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编辑器/">编辑器</a></li></ul></div></ul></div></div><nav class="header-nav"><a href="/" class="archives">home </a><a href="/tags/web-development/" class="archives">web development </a><a href="/tags/soft/" class="archives">soft </a><a href="/tags/os/" class="archives">os </a><a href="/archives" class="archives">archives </a><a href="/README/" class="archives">README</a></nav></div></header><script>NProgress.set(.4)</script><main id="main" role="main"><article id="post-ji-yu-jwtde-deng-lu-yan-zheng-xi-tong-shi-xian" class="post article white-box article-type-post animated fade-in-top" itemscope itemprop="blogPost"><section class="post-header article-header"><h2 class="title"><a href="/2017/06/01/ji-yu-jwtde-deng-lu-yan-zheng-xi-tong-shi-xian/">基于JWT的登录验证系统实现</a></h2><div class="subtitle"><time>Jun 1, 2017 </time><span class="tags"><span class="iconfont icon-tag"></span> <a class="tag-link" href="/tags/web-development/">web development</a></span></div></section><section class="content"><div class="article-entry" itemprop="articleBody"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>基于JWT的简单登录认证流程图：</p><p><img src="/images/2017/06/jwt-1.png" alt></p><h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><blockquote><p>JSON Web token（JWT）是一种开放标准（RFC 7519），它定义了一种紧凑且独立的方式，用于将各方之间的信息安全地传输为JSON对象。该信息可以通过数字签名进行验证和信任。使用密匙 （使用哈希算法）或使用RSA的公钥/私钥对可以对JWT进行签名。</p></blockquote><p>jwt是对于token认证方式的一种规范和描述。</p><h4 id="JWT-的构成"><a href="#JWT-的构成" class="headerlink" title="JWT 的构成"></a>JWT 的构成</h4><p>jwt由三部分构成，并用<code>.</code>作为间隔：</p><ul><li>Header</li><li>Payload</li><li>Signature</li></ul><p>看起来像这样 <code>xxxxx.yyyyy.zzzzz</code></p><h5 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h5><p>Header用来描述token类型和加密算法(HMAC、SHA256、RSA 等)，如下：</p><pre><code class="json">{
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}
</code></pre><h5 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h5><p>这部分用来放置token的有效信息，有<code>reserved，public，private</code>三种类型：</p><ul><li><strong>Reserved claims：</strong> 一些保留类型的，推荐但不强制必须使用，包括以下属性<ul><li><strong>iss</strong>: jwt签发者</li><li><strong>sub</strong>: jwt所面向的用户</li><li><strong>aud</strong>: 接收jwt的一方</li><li><strong>exp</strong>: jwt的过期时间，这个过期时间必须要大于签发时间</li><li><strong>nbf</strong>: 定义在什么时间之前，该jwt都是不可用的.</li><li><strong>iat</strong>: jwt的签发时间</li><li><strong>jti</strong>: jwt的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</li></ul></li><li><strong>Public claims：</strong> 可以随意定义的属性, 但为了避免冲突，他们应该使用 IANA JSON Web Token Registry 定义或使用 URL 定义。</li><li><strong>Private claims:</strong> 这些是为了在同意使用它们的各方之间共享信息而创建的自定义声明。</li></ul><p>一个Payload看起来像这样</p><pre><code class="json">{
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;admin&quot;: true
}
</code></pre><h5 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h5><p>将Header、Payload编码后加上secret，并用Header声明的算法进行加密，看起来伪代码的实现是这样的</p><pre><code class="javascript">HMACSHA256(
  base64UrlEncode(header) + &quot;.&quot; +
  base64UrlEncode(payload),
  secret)
</code></pre><h5 id="把三部分组合起来"><a href="#把三部分组合起来" class="headerlink" title="把三部分组合起来"></a>把三部分组合起来</h5><p>最终的样子像这样</p><pre><code class="javascript">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
</code></pre><h2 id="实现登录认证"><a href="#实现登录认证" class="headerlink" title="实现登录认证"></a>实现登录认证</h2><h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><p><a href="jwt.io">jwt.io</a>网站提供众多后端语言的支持库，帮我们封装好了jwt的一些具体实现，其中包括Node.js的<a href="https://github.com/auth0/node-jsonwebtoken" target="_blank" rel="noopener">node-jsonwebtoken</a> 。</p><h5 id="生成token"><a href="#生成token" class="headerlink" title="生成token"></a>生成token</h5><p><code>jwt.sign(payload, secretOrPrivateKey, [options, callback])</code></p><p><code>jwt.sign</code> 方法中的<code>secretOrPrivateKey</code>即为JWT第三部分<code>Signature</code>中的secret, 它既可以是一个复杂的字符串，也可以是一对密钥对中的<code>PrivateKey</code>。</p><pre><code class="javascript">var privateKey = fs.readFileSync(config.privateKey)
var token = jwt.sign({
    user: oneUser._id,
    exp: Math.floor(Date.now() / 1000) + (30) //30s后过期
}, privateKey, { algorithm: &#39;RS256&#39;})
</code></pre><p>privatekey生成</p><pre><code>ssh-keygen -t rsa -b 4096 -f private.key #生成私钥
# Don&#39;t add passphrase
openssl rsa -in private.key -pubout -outform PEM -out public.key #生成对应公钥
# 生成公钥格式需要是PEM格式的, ss-keygen 也可以生成公钥
# ssh-keygen -f public.key -e -m pem  
cat private.key
cat public.key
</code></pre><h5 id="验证token"><a href="#验证token" class="headerlink" title="验证token"></a>验证token</h5><p><code>jwt.verify(token, secretOrPublicKey, [options, callback])</code></p><pre><code class="javascript">var publicKey = fs.readFileSync(config.publicKey)
try {
  result = jwt.verify(token, publicKey) 
} catch(e) {}
</code></pre><h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>在每次发起需验证请求时在头部携带JWT格式的token</p><pre><code>Authorization: Bearer &lt;token&gt;
</code></pre><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><blockquote><ul><li>体积小，因而传输速度快</li><li>传输方式多样，可以通过 URL/PosT 参数/HTTP 头部 等方式传输</li><li>严谨的结构化。它自身（在 payload 中）就包含了所有与用户相关的验证消息，如用户可访问路由、访问有效期等信息，服务器无需再去连接数据库验证信息的有效性，并且 payload 支持为你的应用而定制化</li><li>支持跨域验证，多应用于单点登录。</li><li>充分依赖无状态 API ，契合 RESTful 设计原则</li><li>验证解耦，无需使用特定的身份验证方案，易于实现分布式</li><li>比 cookie 更支持原生移动端应用</li></ul></blockquote><h2 id="单点登录实现"><a href="#单点登录实现" class="headerlink" title="单点登录实现"></a>单点登录实现</h2><h4 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h4><p>基于jwt的验证方式实现单点登录，只需要在单点（暂时称之为center）登录后通过一定方式将token分发给其他点。</p><p>token的验证可以在center端统一处理，也可将上文提到的<code>publicKey</code>分发给各个点，各个点自行验证。</p><p>token的各个点存储可以通过cookie、localstorage。</p><p><img src="/images/2017/06/jwt-2.png" alt></p><h4 id="退出登录"><a href="#退出登录" class="headerlink" title="退出登录"></a>退出登录</h4><p>退出登录实现和登录类似，请求center退出登录页面，center清理各个点的cookie或者localstorage实现退出登录。</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://medium.com/vandium-software/5-easy-steps-to-understanding-json-web-tokens-jwt-1164c0adfcec" target="_blank" rel="noopener">5 Easy Steps to Understanding JSON Web Tokens (JWT)</a></p><p><a href="https://jwt.io/introduction/" target="_blank" rel="noopener">Introduction to JSON Web Tokens</a></p></div></section><section id="gitalk-container"></section></article><script>NProgress.set(.6)</script></main><footer class="footer"><div class="footer-wrap"><div class="footer-link"><h3>LINKS</h3><p><a href="http://1x0.xyz/" target="_blank">Tian1x0</a> <a href="http://www.royalmice.com/hankzhou/" target="_blank">Hankzhou</a> <a href="http://sjydh.me/" target="_blank">设计有点货</a> <a href="https://developers.google.com/web/fundamentals/" target="_blank">Web fundamentals</a></p></div><div class="footer-tags"><h3>TAGS</h3><div class="tags"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac-os-X/">Mac os X</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/os/">os</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/others/">others</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raspberry-pi/">raspberry pi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/soft/">soft</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development/">web development</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web-development推荐方法/">web development推荐方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/work/">work</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模块加载器/">模块加载器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编辑器/">编辑器</a></li></ul></div></div><div class="footer-info"><div>Theme <span class="codename"><a href="https://github.com/GGICE/hexo-icer" target="_blank">icer</a></span> designed & coded by <a href="https://ice.gs/" target="_blank">GGICE</a></div><div>Copyright &copy; 2019, <a href="/">ICE.GS</a> . All rights reserved .</div></div></div></footer><script>NProgress.set(.8)</script></div><script src="//cdn.x21.xyz/libs/highlight/9.12.0/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad()</script><script src="/js/main.js"></script><script src="/js/md5.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>document.querySelector("#gitalk-container")&&new Gitalk({clientID:"83a3413b0591f7c338af",clientSecret:"177f437bdc6573b374fa1ef51efb03e4c374d921",repo:"ICE.GS",owner:"GGICE",admin:["GGICE"],id:MD5(location.pathname),distractionFreeMode:!1}).render("gitalk-container")</script><script>NProgress.done()</script></body>